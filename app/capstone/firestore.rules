rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // USERS: Each user can read/write their own profile
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // PATIENTS: Only the healthworker/user who owns the patient can read/write
    match /patients/{patientId} {
      allow read, write: if request.auth != null && request.auth.uid == resource.data.healthworkerId;
      // If you use 'userId' instead of 'healthworkerId', change accordingly:
      // allow read, write: if request.auth != null && request.auth.uid == resource.data.userId;
    }

    // PREDICTIONS: Only the user who owns the prediction can read/write
    match /predictions/{predictionId} {
      allow read, write: if request.auth != null && request.auth.uid == resource.data.userId;
    }

    // USER STATS: Only the user can read/write their stats
    match /userStats/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // BACKUPS: Only the user can access their backups and backup history
    match /backups/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      // Subcollection: backup_history
      match /backup_history/{backupId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }

    // PREDICTION HISTORY: Only the user can access their prediction history
    match /prediction_history/{historyId} {
      allow read, write: if request.auth != null && request.auth.uid == resource.data.userId;
    }

    // FEEDBACK: Allow authenticated users to create feedback, admin can read all
    match /feedback/{feedbackId} {
      allow create: if request.auth != null;
      allow read, write: if request.auth != null && 
        (request.auth.uid == resource.data.userId || 
         request.auth.token.admin == true);
    }

    // CONTACT REQUESTS: Allow authenticated users to create contact requests, admin can read all
    match /contact_requests/{requestId} {
      allow create: if request.auth != null;
      allow read, write: if request.auth != null && 
        (request.auth.uid == resource.data.userId || 
         request.auth.token.admin == true);
    }

    // Default: Deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
} 